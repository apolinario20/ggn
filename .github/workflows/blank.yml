name: Debian13 VM Persistent

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  vm:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Instalar dependÃªncias
      # -----------------------------
      - name: Install QEMU + tools
        run: |
          sudo apt update
          sudo apt install -y qemu-system-x86 cloud-image-utils cpu-checker qemu-utils

      # -----------------------------
      # Verificar KVM
      # -----------------------------
      - name: Check KVM
        run: |
          if [ -e /dev/kvm ]; then
            echo "KVM exists"
            ls -l /dev/kvm
          else
            echo "No KVM available"
          fi

      # -----------------------------
      # Restaurar backup da VM
      # -----------------------------
      - name: Download VM Backup
        uses: actions/download-artifact@v4
        with:
          name: debian13-backup
          path: ./vm
        continue-on-error: true

      # -----------------------------
      # Preparar disco
      # -----------------------------
      - name: Prepare VM disk
        run: |
          mkdir -p vm
          if [ ! -f vm/debian13.qcow2 ]; then
            echo "No backup found. Downloading fresh image..."
            wget https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-generic-amd64-daily.qcow2 \
              -O vm/debian13.qcow2
          else
            echo "Backup restored successfully."
          fi

      # -----------------------------
      # Criar cloud-init
      # -----------------------------
      - name: Create cloud-init config
        run: |
          cat <<EOF > vm/user-data
          #cloud-config
          ssh_pwauth: true
          disable_root: false

          chpasswd:
            list: |
              root:root
            expire: false
          EOF

          cat <<EOF > vm/meta-data
          instance-id: debian13
          local-hostname: debian13
          EOF

          cloud-localds vm/seed.iso vm/user-data vm/meta-data

      # -----------------------------
      # ðŸ”‘ TMATE (acesso remoto)
      # -----------------------------
      - name: Start tmate session
        uses: mxschmitt/action-tmate@v3

      - name: Show tmate info
        run: |
          echo "ðŸ”‘ Use o comando abaixo para acessar:"
          cat $HOME/.tmate.sock/ssh || echo "tmate ainda nÃ£o disponÃ­vel"

      # -----------------------------
      # Iniciar VM
      # -----------------------------
      - name: Start VM
        run: |
          TOTAL_RAM=$(awk '/MemTotal/ {print int($2/1024)}' /proc/meminfo)
          VM_RAM=$((TOTAL_RAM*70/100))
          CPU_CORES=$(nproc)

          echo "Detected RAM: $TOTAL_RAM MB"
          echo "Allocating: $VM_RAM MB"

          if [ -e /dev/kvm ]; then
            ACCEL="-enable-kvm"
          else
            ACCEL=""
          fi

          qemu-system-x86_64 \
            $ACCEL \
            -m $VM_RAM \
            -smp $CPU_CORES \
            -drive file=vm/debian13.qcow2,format=qcow2 \
            -drive file=vm/seed.iso,format=raw \
            -net nic \
            -net user,hostfwd=tcp::2222-:22 \
            -nographic &

      # -----------------------------
      # Manter VM ativa
      # -----------------------------
      - name: Keep Alive
        run: sleep 21000

      # -----------------------------
      # Compactar disco
      # -----------------------------
      - name: Compact VM Disk
        run: |
          qemu-img convert -O qcow2 vm/debian13.qcow2 vm/debian13-backup.qcow2
          mv vm/debian13-backup.qcow2 vm/debian13.qcow2

      # -----------------------------
      # Upload backup
      # -----------------------------
      - name: Upload VM Backup
        uses: actions/upload-artifact@v4
        with:
          name: debian13-backup
          path: vm/debian13.qcow2
