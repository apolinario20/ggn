name: Debian13 VM Backup Safe

on:
  workflow_dispatch:

jobs:
  vm:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y qemu-system-x86 qemu-utils cloud-image-utils wget netcat-openbsd

      - name: Prepare folder
        run: mkdir -p vm

      # ğŸ” Restaurar backup se existir
      - name: Download previous backup
        uses: actions/download-artifact@v4
        with:
          name: vm-backup
          path: vm
        continue-on-error: true

      # ğŸ“¦ Baixar imagem se nÃ£o existir
      - name: Download Debian image
        run: |
          if [ ! -f vm/debian13.qcow2 ]; then
            wget https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-generic-amd64-daily.qcow2 \
              -O vm/debian13.qcow2
            qemu-img resize vm/debian13.qcow2 100G
          fi

      # ğŸ”‘ Criar chave SSH
      - name: Generate SSH key
        run: ssh-keygen -t ed25519 -f mykey -N ""

      # â˜ Cloud-init
      - name: Create cloud-init
        run: |
          PUBKEY=$(cat mykey.pub)

          cat <<EOF > vm/user-data
          #cloud-config
          growpart:
            mode: auto
            devices: ['/']
            ignore_growroot_disabled: false

          resize_rootfs: true

          users:
            - name: root
              ssh_authorized_keys:
                - $PUBKEY
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: /bin/bash
              lock_passwd: false

          disable_root: false
          ssh_pwauth: false
          EOF

          cat <<EOF > vm/meta-data
          instance-id: debian13
          local-hostname: debian13
          EOF

          cloud-localds vm/seed.iso vm/user-data vm/meta-data

      # ğŸš€ Iniciar VM
      - name: Start VM
        run: |
          sudo nohup qemu-system-x86_64 \
            -enable-kvm \
            -m 13000 \
            -smp 4 \
            -drive file=vm/debian13.qcow2,format=qcow2 \
            -drive file=vm/seed.iso,format=raw \
            -nic user,hostfwd=tcp::2222-:22 \
            -nographic \
            > vm.log 2>&1 &

          sleep 60

      # ğŸ”‘ TMATE
      - name: Start tmate
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Show SSH command
        run: echo "ssh -i mykey root@localhost -p 2222"

      # â³ Rodar por ~6h
      - name: Keep alive
        run: sleep 21000

      # ğŸ’¾ Compactar disco antes do backup
      - name: Compact disk
        run: |
          qemu-img convert -O qcow2 vm/debian13.qcow2 vm/compact.qcow2
          mv vm/compact.qcow2 vm/debian13.qcow2

      # ğŸ“¤ Upload backup
      - name: Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: vm-backup
          path: vm/debian13.qcow2
